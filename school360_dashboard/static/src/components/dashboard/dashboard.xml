<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="school360_dashboard.DashboardMain">
        <div class="o_school360_dashboard">
            <!-- STATIC SIDEBAR -->
            <div class="dashboard_sidebar">
                <div class="sidebar_logo"><i class="fa fa-graduation-cap"/> SCHOOL 360</div>
                <div class="user_profile_section">
                    <div class="profile_img_container">
                        <t t-if="state.data.user and state.data.user.image">
                            <img t-attf-src="data:image/png;base64,#{state.data.user.image}" />
                        </t>
                        <div class="profile_icon_placeholder" t-else="">
                            <i class="fa fa-user"/>
                        </div>
                    </div>
                    <div class="profile_name"><t t-esc="state.data.user.name or 'User'"/></div>
                    <div class="profile_email"><t t-esc="state.data.user.email or ''"/></div>
                </div>
                <ul class="sidebar_nav">
                    <li t-att-class="{'active': state.activeTab === 'base'}" t-on-click="() => this.setTab('base')"><i class="fa fa-home"/> home</li>
                    <li t-att-class="{'active': state.activeTab === 'academic'}" t-on-click="() => this.setTab('academic')"><i class="fa fa-university"/> academic</li>
                    <li t-att-class="{'active': state.activeTab === 'admission'}" t-on-click="() => this.setTab('admission')"><i class="fa fa-bullhorn"/> admission</li>
                    <li t-att-class="{'active': state.activeTab === 'students'}" t-on-click="() => this.setTab('students')"><i class="fa fa-users"/> students</li>
                    <li t-att-class="{'active': state.activeTab === 'attendance'}" t-on-click="() => this.setTab('attendance')"><i class="fa fa-calendar-check-o"/> attendance</li>
                    <li t-att-class="{'active': state.activeTab === 'staff'}" t-on-click="() => this.setTab('staff')"><i class="fa fa-id-badge"/> staff</li>
                    <li t-att-class="{'active': state.activeTab === 'library'}" t-on-click="() => this.setTab('library')"><i class="fa fa-book"/> library</li>
                </ul>
            </div>

            <div class="dashboard_body">
                <!-- TOP FILTER BAR -->
                <div class="dashboard_filter_bar">
                    <div class="filter_group">
                        <label>Academic Year</label>
                        <select t-on-change="(ev) => this.onFilterChange('year_id', ev)">
                            <option value="">All Years</option>
                            <t t-foreach="state.filterOptions.years" t-as="y" t-key="y.id">
                                <option t-att-value="y.id"><t t-esc="y.name"/></option>
                            </t>
                        </select>
                    </div>
                    <div class="filter_group">
                        <label>Grade</label>
                        <select t-on-change="(ev) => this.onFilterChange('grade_id', ev)">
                            <option value="">All Grades</option>
                            <t t-foreach="state.filterOptions.grades" t-as="g" t-key="g.id">
                                <option t-att-value="g.id"><t t-esc="g.name"/></option>
                            </t>
                        </select>
                    </div>
                    <div class="filter_group">
                        <label>Section</label>
                        <select t-on-change="(ev) => this.onFilterChange('section_id', ev)">
                            <option value="">All Sections</option>
                            <t t-foreach="state.filterOptions.sections" t-as="s" t-key="s.id">
                                <t t-if="!state.filters.grade_id or s.grade_id[0] == state.filters.grade_id">
                                    <option t-att-value="s.id"><t t-esc="s.name"/></option>
                                </t>
                            </t>
                        </select>
                    </div>
                    <div class="filter_group">
                        <label>Student Type</label>
                        <select t-on-change="(ev) => this.onFilterChange('student_type', ev)">
                            <option value="">All Statuses</option>
                            <t t-foreach="state.filterOptions.student_types" t-as="st" t-key="st.id">
                                <option t-att-value="st.id"><t t-esc="st.name"/></option>
                            </t>
                        </select>
                    </div>
                    <div t-if="state.isLoading" class="ms-auto pt-3">
                        <i class="fa fa-circle-o-notch fa-spin text-primary"/> Loading...
                    </div>
                </div>

                <!-- MAIN TAB CONTENT -->
                <div class="tab_content" t-if="!state.isLoading">
                    
                    <!-- 1. HOME TAB -->
                    <div t-if="state.activeTab === 'base'">
                        <div class="kpi_flexible_row">
                            <div class="kpi_card border_blue"><div class="kpi_data"><div class="kpi_title">Earnings</div><div class="kpi_value"><t t-esc="state.data.overview.earnings"/></div></div><div class="kpi_icon text_blue"><i class="fa fa-dollar"/></div></div>
                            <div class="kpi_card border_orange"><div class="kpi_data"><div class="kpi_title">Students</div><div class="kpi_value"><t t-esc="state.data.overview.students"/></div></div><div class="kpi_icon text_orange"><i class="fa fa-users"/></div></div>
                            <div class="kpi_card border_green"><div class="kpi_data"><div class="kpi_title">Staff</div><div class="kpi_value"><t t-esc="state.data.overview.staff"/></div></div><div class="kpi_icon text_green"><i class="fa fa-id-card"/></div></div>
                            <div class="kpi_card border_teal"><div class="kpi_data"><div class="kpi_title">Attendance</div><div class="kpi_value"><t t-esc="state.data.overview.attendance_rate"/>%</div></div><div class="kpi_icon text_teal"><i class="fa fa-star"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-8"><div t-attf-class="chart_card #{(!state.data.overview.earnings_series or state.data.overview.earnings_series.data.length == 0) ? 'empty_chart' : ''}"><h5>Financial Performance</h5><canvas id="homeLine"/></div></div>
                            <div class="col-md-4">
                                <div t-attf-class="chart_card mb-3 #{(!state.data.students.status_chart or state.data.students.status_chart.data.length == 0) ? 'empty_chart' : ''}" style="height:175px"><h5>Student Mix</h5><canvas id="homePie"/></div>
                                <div t-attf-class="chart_card is_bar #{(!state.data.staff.dept_chart or state.data.staff.dept_chart.data.length == 0) ? 'empty_chart' : ''}" style="height:175px"><h5>Staff by Dept</h5><canvas id="homeBar"/></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. STUDENTS TAB -->
                    <div t-if="state.activeTab === 'students'">
                        <div class="kpi_flexible_row">
                            <div class="kpi_card border_blue"><div class="kpi_data"><div class="kpi_title">TOTAL</div><div class="kpi_value" t-esc="state.data.students.total"/></div></div>
                            <div class="kpi_card border_green"><div class="kpi_data"><div class="kpi_title">ACTIVE</div><div class="kpi_value" t-esc="state.data.students.active"/></div></div>
                            <div class="kpi_card border_orange"><div class="kpi_data"><div class="kpi_title">TRANSFERRED</div><div class="kpi_value" t-esc="state.data.students.transferred"/></div></div>
                            <div class="kpi_card border_teal"><div class="kpi_data"><div class="kpi_title">GRADUATED</div><div class="kpi_value" t-esc="state.data.students.graduated"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.students.grade_chart or state.data.students.grade_chart.data.length == 0) ? 'empty_chart' : ''}"><h5>Students per Grade</h5><canvas id="studentBarChart"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.students.status_chart or state.data.students.status_chart.data.length == 0) ? 'empty_chart' : ''}"><h5>Enrollment Status</h5><canvas id="studentPieChart"/></div></div>
                        </div>
                    </div>

                    <!-- 3. ACADEMIC TAB -->
                    <div t-if="state.activeTab === 'academic'">
                        <div class="kpi_flexible_row">
                             <div class="kpi_card border_blue"><div class="kpi_data"><div class="kpi_title">Grades</div><div class="kpi_value" t-esc="state.data.academic.grades_count"/></div></div>
                             <div class="kpi_card border_teal"><div class="kpi_data"><div class="kpi_title">Sections</div><div class="kpi_value" t-esc="state.data.academic.sections_count"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.academic.grade_bar or state.data.academic.grade_bar.data.length == 0) ? 'empty_chart' : ''}"><h5>Sections per Grade</h5><canvas id="academicBar"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.academic.subject_pie or state.data.academic.subject_pie.data.length == 0) ? 'empty_chart' : ''}"><h5>Subjects Distribution</h5><canvas id="academicPie"/></div></div>
                        </div>
                    </div>

                    <!-- 4. ADMISSION TAB -->
                    <div t-if="state.activeTab === 'admission'">
                        <div class="kpi_flexible_row">
                            <div class="kpi_card border_teal"><div class="kpi_data"><div class="kpi_title">Total Applications</div><div class="kpi_value" t-esc="state.data.admission.total"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.admission.growth_bar or state.data.admission.growth_bar.data.length == 0) ? 'empty_chart' : ''}"><h5>Monthly Growth</h5><canvas id="admissionBar"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.admission.status_pie or state.data.admission.status_pie.data.length == 0) ? 'empty_chart' : ''}"><h5>Admission Status</h5><canvas id="admissionPie"/></div></div>
                        </div>
                    </div>

                    <!-- 5. ATTENDANCE TAB -->
                    <div t-if="state.activeTab === 'attendance'">
                        <div class="kpi_flexible_row">
                            <div class="kpi_card border_green"><div class="kpi_data"><div class="kpi_title">Present</div><div class="kpi_value" t-esc="state.data.attendance.present"/></div></div>
                            <div class="kpi_card border_orange"><div class="kpi_data"><div class="kpi_title">Absent</div><div class="kpi_value" t-esc="state.data.attendance.absent"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.attendance.grade_bar or state.data.attendance.grade_bar.data.length == 0) ? 'empty_chart' : ''}"><h5>Attendance by Grade</h5><canvas id="attBar"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.attendance.period_pie or state.data.attendance.period_pie.data.length == 0) ? 'empty_chart' : ''}"><h5>Attendance by Period</h5><canvas id="attPie"/></div></div>
                        </div>
                    </div>

                    <!-- 6. STAFF TAB -->
                    <div t-if="state.activeTab === 'staff'">
                         <div class="kpi_flexible_row">
                            <div class="kpi_card border_blue"><div class="kpi_data"><div class="kpi_title">Total Staff</div><div class="kpi_value" t-esc="state.data.staff.total"/></div></div>
                            <div class="kpi_card border_orange"><div class="kpi_data"><div class="kpi_title">Teachers</div><div class="kpi_value" t-esc="state.data.staff.teachers"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.staff.dept_chart or state.data.staff.dept_chart.data.length == 0) ? 'empty_chart' : ''}"><h5>Staff per Dept</h5><canvas id="staffBarChart"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.staff.job_pie or state.data.staff.job_pie.data.length == 0) ? 'empty_chart' : ''}"><h5>Job Roles</h5><canvas id="staffPie"/></div></div>
                        </div>
                    </div>

                    <!-- 7. LIBRARY TAB -->
                    <div t-if="state.activeTab === 'library'">
                        <div class="kpi_flexible_row">
                            <div class="kpi_card border_blue"><div class="kpi_data"><div class="kpi_title">Books</div><div class="kpi_value" t-esc="state.data.library.total_books"/></div></div>
                            <div class="kpi_card border_green"><div class="kpi_data"><div class="kpi_title">Borrowed</div><div class="kpi_value" t-esc="state.data.library.borrows"/></div></div>
                            <div class="kpi_card border_orange"><div class="kpi_data"><div class="kpi_title">Overdue</div><div class="kpi_value" t-esc="state.data.library.overdue"/></div></div>
                        </div>
                        <div class="row">
                            <div class="col-md-7"><div t-attf-class="chart_card is_bar #{(!state.data.library.status_bar or state.data.library.status_bar.data.length == 0) ? 'empty_chart' : ''}"><h5>Borrow Status</h5><canvas id="libraryBarChart"/></div></div>
                            <div class="col-md-5"><div t-attf-class="chart_card #{(!state.data.library.cat_chart or state.data.library.cat_chart.data.length == 0) ? 'empty_chart' : ''}"><h5>Book Categories</h5><canvas id="libraryPieChart"/></div></div>
                        </div>
                    </div>
                </div>

                <div t-else="" class="text-center mt-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Analyzing school data...</p>
                </div>

                <footer class="dashboard_footer">
                    <span>Powered by <strong>BellTech Solutions</strong></span>
                </footer>
            </div>
        </div>
    </t>
</templates>